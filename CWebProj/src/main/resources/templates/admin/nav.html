<!DOCTYPE html>
<html layout:decorate="~{layouts/layout_board}">

<head>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <style>
    .dragging {
      opacity: 0.5;
    }
    .nav-item-placeholder, .list-item-placeholder {
      background: #f0f0f0;
      border: 1px dashed #ccc;
      height: 40px;
    }
  </style>
</head>


    <div layout:fragment="content_main">

<ul class="nav nav-tabs" id="menu" role="tablist">
	<li class="nav-item" role="presentation" draggable="true"  th:each="groupMenu, iterStat : ${groupedMenuCategories}">
		<button class="nav-link" th:classappend="${iterStat.index == 0} ? 'active'" 
            th:id="${groupMenu.value[0].menuName + '-tab'}"
            th:data-bs-target="'#' + ${groupMenu.value[0].menuName + '-tab-pane'}"
            th:aria-controls="${groupMenu.value[0].menuName + '-tab-pane'}"
            th:text="${groupMenu.value[0].menuName}"
            data-bs-toggle="tab"
            type="button"
            role="tab"
            th:aria-selected="${iterStat.index == 0}">
   		 </button>
	</li>
</ul>
<!-- <div class="d-flex flex-row-reverse"><button class="nav-item btn btn-outline-success" type="submit">메뉴 추가</button></div> -->

<div class="tab-content" id="category">
	<div  th:each="groupMenu, iterStat : ${groupedMenuCategories}" class="tab-pane fade" th:classappend="${iterStat.index == 0} ? 'show active'" 
	     th:id="${groupMenu.value[0].menuName + '-tab-pane'}" 
	     role="tabpanel" 
	     th:aria-labelledby="${groupMenu.value[0].menuName + '-tab'}" 
	     tabindex="0">
	    <ol class="list-group list-group-numbered" th:id="${groupMenu.value[0].menuName + '-list'}">
	        <li class="list-group-item" draggable="true" 
	        	th:each="category : ${groupMenu.value}"
	        	th:text="${category.categoryName}"></li>
	    </ol>
	    <form action="/nav/edit" method="post">
	    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
	    <input type="text" name="navInput">
	    <button class="btn btn-outline-success end" type="submit">추가</button>
	    
	    </form>
	    
	</div>
</div>	


  <script>
  document.addEventListener('DOMContentLoaded', () => {
	  const tabs = document.querySelectorAll('.nav-item[draggable="true"]');
	  const tabLists = document.querySelectorAll('.list-group-item[draggable="true"]');
	  let draggedItem = null;
	  
	  function handleDragStart(e) {
	    draggedItem = this;
	    setTimeout(() => {
	      this.classList.add('dragging');
	    }, 0);
	  }

	  function handleDragEnd() {
	    setTimeout(() => {
	      draggedItem = null;
	      this.classList.remove('dragging');
	      saveTabOrder();
	      saveItemListOrder();
	    }, 0);
	  }

	  function handleDragOver(e) {
	    e.preventDefault();
	  }

	  function handleDragEnter(e) {
	    e.preventDefault();
	    if (this !== draggedItem) {
	      this.classList.add('nav-item-placeholder');
	    }
	  }

	  function handleDragLeave() {
	    this.classList.remove('nav-item-placeholder');
	  }

	  function handleDrop() {
	    this.classList.remove('nav-item-placeholder');
	    if (this !== draggedItem) {
	      const list = draggedItem.parentNode;
	      const nodes = Array.from(list.children);
	      const draggedIndex = nodes.indexOf(draggedItem);
	      const targetIndex = nodes.indexOf(this);
	      if (draggedIndex < targetIndex) {
	        list.insertBefore(draggedItem, this.nextSibling);
	      } else {
	        list.insertBefore(draggedItem, this);
	      }
	      updateTabContentOrder();
	    }
	  }

	  tabs.forEach(tab => {
	    tab.addEventListener('dragstart', handleDragStart);
	    tab.addEventListener('dragend', handleDragEnd);
	    tab.addEventListener('dragover', handleDragOver);
	    tab.addEventListener('dragenter', handleDragEnter);
	    tab.addEventListener('dragleave', handleDragLeave);
	    tab.addEventListener('drop', handleDrop);
	  });

	  tabLists.forEach(item => {
	    item.addEventListener('dragstart', handleDragStart);
	    item.addEventListener('dragend', handleDragEnd);
	    item.addEventListener('dragover', handleDragOver);
	    item.addEventListener('dragenter', handleDragEnter);
	    item.addEventListener('dragleave', handleDragLeave);
	    item.addEventListener('drop', handleDrop);
	  });

	  // Ensure Bootstrap tabs function correctly
	  document.querySelectorAll('.nav-link').forEach(function(link) {
	    link.addEventListener('click', function(event) {
	      event.preventDefault();
	      let tabId = this.getAttribute('data-bs-target');
	      if (!tabId) return; // 탭 ID가 없으면 종료
	      let tabPane = document.querySelector(tabId);
	      if (!tabPane) return; // 탭 패널이 없으면 종료
	      let tab = new bootstrap.Tab(tabPane);
	      tab.show();
	    });
	  });

	  function updateTabContentOrder() {
	    const tabList = document.querySelector('.nav-tabs');
	    if (!tabList) return; // 탭 리스트가 없으면 종료

	    const tabOrder = Array.from(tabList.children).map(tab => {
	      const button = tab.querySelector('.nav-link');
	      return button ? button.getAttribute('data-bs-target') : null;
	    }).filter(Boolean);

	    tabOrder.forEach((tabPaneId, index) => {
	      const tabPane = document.querySelector(tabPaneId);
	      if (tabPane && tabPane.parentNode) {
	        tabPane.parentNode.appendChild(tabPane);
	      }
	    });
	  }

	  function saveTabOrder() {
	    const tabOrder = Array.from(document.querySelectorAll('.nav-tabs .nav-item')).map(tab => {
	      const button = tab.querySelector('.nav-link');
	      return button ? button.textContent : null;
	    }).filter(Boolean);
	    console.log('메뉴:', tabOrder);
	    // 메뉴 순서 출
	  }

	  function saveItemListOrder() {
	    const tabPanes = document.querySelectorAll('.tab-pane');
	    tabPanes.forEach(tabPane => {
	      const items = tabPane.querySelectorAll('.list-group-item[draggable="true"]');
	      const itemOrder = Array.from(items).map(item => item.textContent.trim());
	      console.log(`Order for ${tabPane.id}:`, itemOrder);
	      // 카테고리 순서 출력
	    });
	  }
	});
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.11.6/umd/popper.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.1.3/js/bootstrap.min.js"></script>
</div>
</html>